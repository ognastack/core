_format_version: "3.0"
_transform: true

consumers:
  - username: ogna-user
    jwt_secrets:
      - key: authenticated # This must match GoTrue JWT 'aud'
        secret: superlongjwtsecret # The same JWT secret GoTrue uses
        algorithm: HS256

services:
  - name: gotrue-service
    url: http://gotrue:9999
    routes:
      - name: gotrue-route
        paths:
          - /auth

  # FastAPI backend
  - name: api-service
    url: http://api:8000
    routes:
      - name: api-route
        paths:
          - /api
    plugins:
      - name: jwt
        config:
          claims_to_verify:
            - exp
          key_claim_name: aud # optional: use 'aud' as the key if needed
      - name: rate-limiting
        config:
          second: 30 # max 5 requests per second
          minute: 100 # max 100 requests per minute
          policy: local # uses Kong node memory, good for single instance



plugins:
  - name: cors
    config:
      origins:
        - http://localhost:3000
        - http://127.0.0.1:3000
        - http://localhost:5173
        - http://127.0.0.1:5173
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
      credentials: true
  - name: jwt-blacklist
    config:
      redis_host: redis
      redis_port: 6379
